apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: auth-typewriter-permissions
  annotations:
    version: v0.0.1
    description: 'Generate NATS permissions for a given Claim of a user'
spec:
  policies:
    - name: vault
      type: policy.secret.wasmcloud.dev/v1alpha1
      properties:
        backend: 'vault'
        role_name: 'auth-callout-role'
        mount_path: 'jwt'
  components:
    - name: auth-typewriter-permissions
      type: component
      properties:
        image: registry:5001/auth_typewriter_permissions:0.1.0
      traits:
        - type: spreadscaler
          properties:
            instances: 100
        - type: link
          properties:
            target:
              name: surrealdb-provider
            namespace: seamlezz
            package: surrealdb
            interfaces: [call]
        - type: link
          properties:
            target:
              name: nats
              secrets:
                - name: client_jwt
                  properties:
                    policy: vault
                    key: nats/auth/callout
                    field: jwt
                    version: '1'
                - name: client_seed
                  properties:
                    policy: vault
                    key: nats/auth/callout
                    field: seed
                    version: '1'
              config:
                - name: auth-typewriter-permissions-consumer
                  properties:
                    cluster_uris: 'nats://nats:4222'
            namespace: wasmcloud
            package: messaging
            interfaces: [consumer]

    - name: nats
      type: capability
      properties:
        image: ghcr.io/wasmcloud/messaging-nats:0.27.0
      traits:
        - type: link
          properties:
            target:
              name: auth-typewriter-permissions
            namespace: wasmcloud
            package: messaging
            interfaces: [handler]
            source:
              secrets:
                - name: client_jwt
                  properties:
                    policy: vault
                    key: nats/auth/callout
                    field: jwt
                    version: '1'
                - name: client_seed
                  properties:
                    policy: vault
                    key: nats/auth/callout
                    field: seed
                    version: '1'
              config:
                - name: auth-typewriter-permissions-subscription
                  properties:
                    subscriptions: 'auth.permissions.typewriter'
                    cluster_uris: 'nats://nats:4222'
    - name: surrealdb-provider
      type: capability
      properties:
        image: registry:5001/surrealdb_provider:0.1.0 
        config:
          - name: auth-typewriter-permissions-surrealdb
            properties:
              namespace: typewriter
              database: develop
              auth: root
              username: root
              password: root
              url: ws://surrealdb:9000

