---
difficulty: Hard
---

import Player from "@site/src/components/Player";
import Image from "@site/src/components/Image";
import EntrySearch from "@site/src/components/EntrySearch";
import ActionButton from "@site/src/components/ActionButtons";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Привязка опции
:::danger[Перед началом]
Это руководство рассчитано на опытных пользователей. Желательно хорошо разбираться в [Взаимодействиях](../../01-interactions/index.mdx) и [Границах взаимодействия](./).
:::
:::info[Сюжет]
По сюжету официант спрашивает, за какой столик игрок хочет присесть.
:::

В этом руководстве мы создадим опцию с привязанной границей взаимодействия. При прокрутке вариантов будет меняться позиция игрока.

## Создание опции
:::info[Расширение Entity]
В примере опция будет связана с событием `On Entity Interact Event` из [Entity Extension](../../04-entity-extension/index.mdx).
:::

### Создаём диалог опций
Сначала создадим диалог опций, который увидит игрок при взаимодействии с официантом:

1. Щёлкните правой кнопкой на записи `On Entity Interact Event` и выберите `+ Link with ...`
2. Найдите `Option` и добавьте её в последовательность

<EntrySearch entryName="option" />

## Настройка опции
После добавления откройте инспектор `Option`.

Задайте текст диалога: `Добро пожаловать, за какой столик вы хотели бы сесть?` и варианты:
- **Spruce Table**
- **Birch Table**
- **Dark Oak Table**
- **Go Back**

Подробнее о настройке опций смотрите в [руководстве по опциям](../../01-interactions/01-options.mdx).

## Добавляем границу взаимодействия
Щёлкните правой кнопкой по `On Entity Interact Event` и выберите `Link with ...`, затем найдите `Lock Interaction Bound` и добавьте её в последовательность.
<EntrySearch entryName='lock_interaction_bound' />

## Настройка границы
Выберите `Lock Interaction Bound` и откройте инспектор.

### Добавляем переменную Case
Включите параметр Target Position и нажмите на иконку <ActionButton button='dynamic-variable'/>. Найдите `Add Case Variable` и добавьте на страницу фактов.

<EntrySearch entryName="case_variable" />

### Настройка Case Variable
Откройте инспектор `Case Variable`.

:::info[Case Variable]
Переменная хранит разные позиции, зависящие от числа:

- Система **однобазная** (индексация с 1)
- Case 0 — позиция по умолчанию (если совпадение не найдено)
- При отсутствии подходящего кейса используется значение по умолчанию
:::

Для нашего ресторана:
1. Задайте **положение по умолчанию**, нажав <ActionButton button='capture'/> (используется, когда кейс не найден)
2. Нажмите `+` в поле кейсов и добавьте четыре позиции обзора:
   - **Case 1**: место у елового столика
   - **Case 2**: место у берёзового столика
   - **Case 3**: место у тёмного дубового столика
   - **Case 4**: вернуться на исходную позицию
3. Захватите каждое положение через <ActionButton button='capture'/>
4. В итоге `Case Variable` будет выглядеть так:
<Image img={require("../../../assets/interactions/option-bound-case-variables.png")} width="400" />

### Добавляем переменную контекста взаимодействия
По умолчанию при прокрутке вариантов ничего не происходит. Добавим `Interaction Context Variable` внутрь `Case Variable` в записи `Lock Interaction Bound`.

Нажмите <ActionButton button='dynamic-variable'/> в поле `Selection` у `Case Variable` и выберите `Interaction Context Variable`.

<EntrySearch entryName="interaction_context_variable" />

### Настройка переменной контекста
Эта переменная автоматически предоставляет индекс выбранной опции:

1. Выберите `Interaction Context Variable`
2. В инспекторе нажмите `Select a Entry`
3. Укажите созданную ранее запись `Option`
4. В итоге `Interaction Context Variable` будет выглядеть так:
<Image img={require("../../../assets/interactions/option-bound-target-position.png")} width="400" />

:::info[О количестве кейсов]
На изображении указано `Cases (0)`, потому что кейсы настроены глобально на странице фактов, а не локально в этой записи. Переменные можно задавать глобально (на странице фактов) или локально (в конкретной записи) — функциональность одинаковая.
:::
## Результат
Теперь страницы должны выглядеть примерно так:
<Tabs Group defaultValue="sequence" groupId="page" queryString>
   <TabItem value="sequence" label="Sequence Page">
      <Image img={require("../../../assets/interactions/option-bound-sequence.png")} />
   </TabItem>
   <TabItem value="static" label="Static Page">
      <Image img={require("../../../assets/interactions/option-bound-static.png")} />
   </TabItem>
</Tabs>
Когда игрок общается с официантом, перед ним появляется меню опций. Перемещаясь по вариантам, камера автоматически поворачивается к соответствующему столику, что создаёт эффект присутствия.

<Player url={require("../../../assets/interactions/option-bound-result.webm").default} />

:::warning[Клавиша подтверждения]
Во время написания документации был найден баг с клавишей подтверждения. Если она назначена на `SWAP_HANDS` (F), то внутри границы диалог не продолжится. Нужно нажимать SPACE.
:::

## Как это работает
Система Option Bound состоит из следующих элементов:

1. **Lock Interaction Bound** — контролирует позицию и взгляд игрока
2. **Case Variable** — хранит позиции для каждого варианта
3. **Interaction Context Variable** — передаёт текущий индекс опции
4. **Option Entry** — отображает интерфейс диалога

Когда игрок переключает варианты, `Interaction Context Variable` обновляется новым индексом, выбирает соответствующую позицию из `Case Variable`, и `Lock Interaction Bound` применяет её к игроку.

Это обеспечивает плавное перемещение взгляда к выбранному варианту, позволяя "осмотреть" выбор прямо в игровом мире.
